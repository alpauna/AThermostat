<html><head><title>Pins - AThermostat</title>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<link rel='stylesheet' href='/theme.css'>
<script>document.documentElement.dataset.theme=localStorage.getItem('hp-theme')||'dark'</script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:0;background:var(--bg);}
nav{background:var(--nav-bg);padding:10px 20px;display:flex;align-items:center;gap:18px;}
nav a{color:#fff;text-decoration:none;font-size:14px;padding:6px 12px;border-radius:4px;}
nav a:hover,nav a.active{background:#4CAF50;}
nav .brand{font-weight:bold;font-size:16px;margin-right:auto;color:#fff;}
.content{max-width:700px;margin:20px auto;padding:0 20px;}
h1{color:var(--text);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:15px;margin-bottom:15px;}
.card h3{margin-top:0;color:#4CAF50;}
table{width:100%;border-collapse:collapse;}
th,td{text-align:left;padding:8px 12px;border-bottom:1px solid var(--border-light);font-size:14px;}
th{color:var(--text-secondary);font-weight:normal;}
td{color:var(--text);}
.on{color:#4CAF50;font-weight:bold;}
.off{color:var(--text-muted);}
.protected{color:#ff9800;}
.strapping{color:#f44336;}
.footer{text-align:center;color:var(--text-muted);font-size:12px;margin-top:10px;}
.adv-toggle{display:flex;align-items:center;gap:8px;margin-bottom:15px;color:var(--text-secondary);font-size:14px;cursor:pointer;}
.adv-toggle input{margin:0;cursor:pointer;}
.adv-toggle .hint{color:var(--text-muted);font-size:12px;font-style:italic;}
.adv-section{display:none;}
.adv-section.show{display:block;}
</style></head><body>
<nav><span class='brand'>AThermostat</span>
<button class='hamburger' onclick='this.nextElementSibling.classList.toggle("open")'><span></span><span></span><span></span></button>
<div class='nav-links'>
<a href='/dashboard'>Dashboard</a>
<a href='/pins' class='active'>Pins</a>
<a href='/config'>Config</a>
<a href='/update'>Update</a>
<a href='/log/view'>Log</a>
<a href='/heap/view'>Heap</a>
<a href='#' class='reboot' onclick="if(confirm('Reboot device?')){var x=new XMLHttpRequest();x.open('POST','/reboot');x.onload=function(){alert(x.status===200?'Rebooting...':'Failed')};x.send()};return false">Reboot</a>
</div></nav>
<div class='content'>
<h1>Pins</h1>
<div class='card'>
<h3>Outputs (Relays)</h3>
<table>
<tr><th>Name</th><th>GPIO</th><th>State</th></tr>
<tbody id='outTable'><tr><td colspan='3'>Loading...</td></tr></tbody>
</table>
</div>
<div class='card'>
<h3>Inputs</h3>
<table>
<tr><th>Name</th><th>GPIO</th><th>State</th></tr>
<tbody id='inTable'><tr><td colspan='3'>Loading...</td></tr></tbody>
</table>
</div>
<label class='adv-toggle' title='Shows eFuse-Changeable Pins and Burned eFuses tables with detailed ESP32-S3 one-time-programmable fuse status'>
<input type='checkbox' id='advToggle' onchange='toggleAdv(this.checked)'> Show Advanced Pin Info
<span class='hint'>(eFuse details)</span>
</label>
<div id='advSection' class='adv-section'>
<div class='card'>
<h3>eFuse-Changeable Pins</h3>
<p style='color:var(--text-secondary);font-size:13px;margin-top:0'>Pins whose function can be changed by burning eFuses. <span class='strapping'>PERMANENT</span> -cannot be undone.</p>
<table>
<tr><th>GPIO</th><th>Current Use</th><th>eFuse</th><th>Effect</th><th>Status</th></tr>
<tbody id='efusePinTable'><tr><td colspan='5'>Loading...</td></tr></tbody>
</table>
</div>
<div class='card'>
<h3>Burned eFuses</h3>
<p style='color:var(--text-secondary);font-size:13px;margin-top:0'>Current state of security and configuration eFuses.</p>
<table>
<tr><th>eFuse</th><th>Value</th><th>Description</th></tr>
<tbody id='efuseTable'><tr><td colspan='3'>Loading...</td></tr></tbody>
</table>
</div>
</div>
<div class='card'>
<h3>Protected Pins (ESP32-S3)</h3>
<table>
<tr><th>GPIO</th><th>Function</th><th>eFuse State</th><th>Notes</th></tr>
<tbody id='protectedTable'>
<tr><td>0</td><td class='strapping'>Strapping</td><td class='off'>-</td><td>Boot mode select -do not use</td></tr>
<tr><td>3</td><td class='strapping'>Strapping</td><td id='prot_3' class='off'>-</td><td>JTAG signal source select</td></tr>
<tr><td>19</td><td class='protected'>USB</td><td id='prot_19' class='off'>-</td><td>USB_D- (USB-JTAG) -used for HX710 #1 DOUT</td></tr>
<tr><td>20</td><td class='protected'>USB</td><td id='prot_20' class='off'>-</td><td>USB_D+ (USB-JTAG) -used for HX710 #1 CLK</td></tr>
<tr><td>26</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>27</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>28</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>29</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>30</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>31</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>32</td><td class='protected'>SPI Flash</td><td class='off'>-</td><td>Connected to SPI flash -do not use</td></tr>
<tr><td>33</td><td class='protected'>PSRAM</td><td class='off'>-</td><td>Octal PSRAM -do not use</td></tr>
<tr><td>34</td><td class='protected'>PSRAM</td><td class='off'>-</td><td>Octal PSRAM -do not use</td></tr>
<tr><td>35</td><td class='protected'>PSRAM</td><td class='off'>-</td><td>Octal PSRAM -do not use</td></tr>
<tr><td>36</td><td class='protected'>PSRAM</td><td class='off'>-</td><td>Octal PSRAM -do not use</td></tr>
<tr><td>37</td><td class='protected'>PSRAM</td><td class='off'>-</td><td>Octal PSRAM -do not use</td></tr>
<tr><td>39-42</td><td class='protected'>JTAG</td><td id='prot_39' class='off'>-</td><td>JTAG pads -can be freed via DIS_PAD_JTAG</td></tr>
<tr><td>43</td><td class='protected'>UART</td><td class='off'>-</td><td>U0TXD -serial TX</td></tr>
<tr><td>44</td><td class='protected'>UART</td><td class='off'>-</td><td>U0RXD -serial RX</td></tr>
<tr><td>45</td><td class='strapping'>Strapping</td><td id='prot_45' class='off'>-</td><td>VDD_SPI voltage -used for out_temp_ok input</td></tr>
<tr><td>46</td><td class='strapping'>Strapping</td><td class='off'>-</td><td>Boot mode / ROM log output</td></tr>
</tbody>
</table>
</div>
<div id='footer' class='footer'></div>
</div>
<script>
function toggleAdv(on){
  document.getElementById('advSection').className=on?'adv-section show':'adv-section';
  localStorage.setItem('pins-adv',on?'1':'0');
}
(function(){var v=localStorage.getItem('pins-adv');if(v==='1'){document.getElementById('advToggle').checked=true;toggleAdv(true);}})();
function load(){
  var xhr=new XMLHttpRequest();
  xhr.open('GET','/api/pins',true);
  xhr.onload=function(){
    if(xhr.status===200){
      try{
        var d=JSON.parse(xhr.responseText);
        var oHtml='';
        if(d.outputs){
          for(var i=0;i<d.outputs.length;i++){
            var o=d.outputs[i];
            oHtml+="<tr><td>"+o.name+"</td><td>"+o.boardPin+"</td><td class='"+(o.on?'on':'off')+"'>"+(o.on?'ON':'OFF')+"</td></tr>";
          }
        }
        document.getElementById('outTable').innerHTML=oHtml||'<tr><td colspan="3">No outputs</td></tr>';
        var iHtml='';
        if(d.inputs){
          for(var i=0;i<d.inputs.length;i++){
            var inp=d.inputs[i];
            iHtml+="<tr><td>"+inp.name+"</td><td>"+inp.boardPin+"</td><td class='"+(inp.active?'on':'off')+"'>"+(inp.active?'ACTIVE':'INACTIVE')+"</td></tr>";
          }
        }
        document.getElementById('inTable').innerHTML=iHtml||'<tr><td colspan="3">No inputs</td></tr>';
        document.getElementById('footer').textContent='Updated: '+new Date().toLocaleTimeString();
      }catch(e){}
    }
  };
  xhr.send();
}
load();
setInterval(load,2000);
function loadEfuse(){
  var xhr=new XMLHttpRequest();
  xhr.open('GET','/api/efuse',true);
  xhr.onload=function(){
    if(xhr.status===200){
      try{
        var e=JSON.parse(xhr.responseText);
        var pinRows=[
          {gpio:'19, 20',use:'USB D-/D+ (HX710 #1)',efuse:'DIS_USB_JTAG',effect:'Frees GPIO19/20 from USB-JTAG',field:'DIS_USB_JTAG'},
          {gpio:'19, 20',use:'USB Serial JTAG',efuse:'DIS_USB_SERIAL_JTAG',effect:'Disables USB serial JTAG on GPIO19/20',field:'DIS_USB_SERIAL_JTAG'},
          {gpio:'19, 20',use:'USB D-/D+',efuse:'USB_EXCHG_PINS',effect:'Swaps USB D- and D+ pin assignment',field:'USB_EXCHG_PINS'},
          {gpio:'39-42',use:'JTAG pads',efuse:'DIS_PAD_JTAG',effect:'Permanently disables pad JTAG',field:'DIS_PAD_JTAG'},
          {gpio:'39-42',use:'JTAG pads',efuse:'SOFT_DIS_JTAG',effect:'Software-disables JTAG (reversible via HMAC)',field:'SOFT_DIS_JTAG'},
          {gpio:'3',use:'Strapping (JTAG)',efuse:'STRAP_JTAG_SEL',effect:'Enables GPIO3 strapping for JTAG source select',field:'STRAP_JTAG_SEL'},
          {gpio:'45',use:'VDD_SPI strapping',efuse:'VDD_SPI_FORCE',effect:'Forces VDD_SPI from eFuse, frees GPIO45',field:'VDD_SPI_FORCE'}
        ];
        var h='';
        for(var i=0;i<pinRows.length;i++){
          var r=pinRows[i];
          var burned=e[r.field];
          h+="<tr><td>"+r.gpio+"</td><td>"+r.use+"</td><td style='font-family:monospace;font-size:12px'>"+r.efuse+"</td><td>"+r.effect+"</td><td class='"+(burned?'strapping':'on')+"'>"+(burned?'BURNED':'NOT SET')+"</td></tr>";
        }
        document.getElementById('efusePinTable').innerHTML=h;
        var secRows=[
          {name:'DIS_USB_JTAG',desc:'Disable USB-JTAG debug'},
          {name:'DIS_USB_SERIAL_JTAG',desc:'Disable USB serial JTAG'},
          {name:'DIS_PAD_JTAG',desc:'Permanently disable pad JTAG (GPIO39-42)'},
          {name:'SOFT_DIS_JTAG',desc:'Software-disable JTAG (can reenable via HMAC)'},
          {name:'USB_EXCHG_PINS',desc:'Swap USB D-/D+ pins'},
          {name:'USB_EXT_PHY_ENABLE',desc:'Enable external USB PHY'},
          {name:'USB_PHY_SEL',desc:'USB PHY selection'},
          {name:'STRAP_JTAG_SEL',desc:'Enable JTAG selection via GPIO3 strapping'},
          {name:'VDD_SPI_XPD',desc:'VDD_SPI regulator power up'},
          {name:'VDD_SPI_TIEH',desc:'VDD_SPI voltage: 0=1.8V, 1=3.3V'},
          {name:'VDD_SPI_FORCE',desc:'Force VDD_SPI from eFuse (frees GPIO45)'},
          {name:'PIN_POWER_SELECTION',desc:'GPIO33-37 power source: 0=VDD_SPI, 1=VDD3P3_CPU'},
          {name:'DIS_USB',desc:'Disable USB OTG'},
          {name:'DIS_DOWNLOAD_MODE',desc:'Disable UART download mode'},
          {name:'DIS_DIRECT_BOOT',desc:'Disable direct boot from flash'},
          {name:'SECURE_BOOT_EN',desc:'Enable secure boot'},
          {name:'SPI_BOOT_CRYPT_CNT',desc:'Flash encryption counter (3 bits)'},
          {name:'UART_PRINT_CONTROL',desc:'UART boot log: 0=on, 1=on if GPIO46 low, 2=on if GPIO46 high, 3=off'}
        ];
        var sh='';
        for(var i=0;i<secRows.length;i++){
          var r=secRows[i];
          var v=e[r.name];
          var isSet=(typeof v==='boolean')?v:(v>0);
          sh+="<tr><td style='font-family:monospace;font-size:12px'>"+r.name+"</td><td class='"+(isSet?'strapping':'off')+"'>"+(typeof v==='boolean'?(v?'BURNED':'NOT SET'):v)+"</td><td>"+r.desc+"</td></tr>";
        }
        document.getElementById('efuseTable').innerHTML=sh;
        // Update eFuse State column in Protected Pins table
        var p3=document.getElementById('prot_3');
        if(p3){if(e.STRAP_JTAG_SEL){p3.className='strapping';p3.textContent='JTAG SEL ACTIVE';}else{p3.className='off';p3.textContent='Default';}}
        var p19=document.getElementById('prot_19');
        var p20=document.getElementById('prot_20');
        if(p19&&p20){
          var usbFreed=e.DIS_USB_JTAG&&e.DIS_USB_SERIAL_JTAG;
          if(usbFreed){p19.className='on';p19.textContent='FREED (JTAG off)';p20.className='on';p20.textContent='FREED (JTAG off)';}
          else if(e.DIS_USB_JTAG){p19.className='protected';p19.textContent='USB-JTAG off';p20.className='protected';p20.textContent='USB-JTAG off';}
          else if(e.DIS_USB_SERIAL_JTAG){p19.className='protected';p19.textContent='Serial JTAG off';p20.className='protected';p20.textContent='Serial JTAG off';}
          else{p19.className='off';p19.textContent='Default';p20.className='off';p20.textContent='Default';}
          if(e.USB_EXCHG_PINS){p19.textContent+=' (swapped)';p20.textContent+=' (swapped)';}
        }
        var p39=document.getElementById('prot_39');
        if(p39){if(e.DIS_PAD_JTAG){p39.className='on';p39.textContent='FREED (JTAG off)';}else if(e.SOFT_DIS_JTAG){p39.className='protected';p39.textContent='Soft disabled';}else{p39.className='off';p39.textContent='Default';}}
        var p45=document.getElementById('prot_45');
        if(p45){if(e.VDD_SPI_FORCE){p45.className='on';p45.textContent='FREED (VDD '+(e.VDD_SPI_TIEH?'3.3V':'1.8V')+')';}else{p45.className='off';p45.textContent='Default';}}
      }catch(ex){}
    }
  };
  xhr.send();
}
loadEfuse();
fetch('/theme').then(function(r){return r.json()}).then(function(d){var t=d.theme||'dark';document.documentElement.dataset.theme=t;localStorage.setItem('hp-theme',t);if(d.systemName){var b=document.querySelector('.brand');if(b)b.textContent=d.systemName;document.title=document.title.replace('AThermostat',d.systemName);}}).catch(function(){});
</script>
<div class="btt" id="btt" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Back to top">&#9650;</div>
<script>window.addEventListener('scroll',function(){document.getElementById('btt').classList.toggle('show',window.scrollY>300)});</script>
</body></html>
